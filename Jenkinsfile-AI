pipeline {
    agent any
    environment {
        DOCKER_HUB_CREDENTIALS_ID = 'dockerhub-access-jaehyun' 
        MYSQL_USER = credentials('MYSQL_USER')       
        MYSQL_PASSWORD = credentials('MYSQL_PASSWORD')           
        MYSQL_DATABASE = credentials('MYSQL_DATABASE')      
        SPRING_PROFILES_ACTIVE = 'prod'                       
    }

    stages {
        stage('Clone Repository') {
            steps {
                script {
                    echo 'Cloning Repository...'
                    git url: 'https://lab.ssafy.com/s11-final/S11P31A609.git', branch: 'develop', credentialsId: 'gitlab-access-jaehyun'
                    echo 'Repository Clone Success!'
                }
            }
        }

        stage('Build Backend') {
            steps {
                dir('BE') {
                    script {
                        echo 'Building Backend Application...'
                        sh './gradlew clean build -x test'
                        echo 'Backend Application Build Success!'

                        echo 'Building Backend Image...'
                        sh 'docker build -t kimjaehyun158/trai-backend:latest -f Dockerfile .'
                        echo 'Backend Image Build Success!'
                    }
                }
            }
        }

        stage('Build Frontend') {
            steps {
                dir('FE/trai') {
                    script {
                        echo 'Building Frontend Image...'
                        sh 'docker build -t kimjaehyun158/trai-frontend:latest -f Dockerfile .'
                        echo 'Frontend Image Build Success!'
                    }
                }
            }
        }

        stage('Push Images to Docker Hub') {
            steps {
                script {
                    echo 'Logging in to Docker Hub...'
                    withCredentials([usernamePassword(credentialsId: DOCKER_HUB_CREDENTIALS_ID, usernameVariable: 'DOCKER_HUB_USERNAME', passwordVariable: 'DOCKER_HUB_PASSWORD')]) {
                        sh 'echo "${DOCKER_HUB_PASSWORD}" | docker login -u "${DOCKER_HUB_USERNAME}" --password-stdin'
                    }
                    
                    echo 'Pushing Images to Docker Hub...'
                    sh 'docker push kimjaehyun158/trai-backend:latest'
                    sh 'docker push kimjaehyun158/trai-frontend:latest'
                    echo 'Images Push Success!'
                }
            }
        }

        stage('Deploy with Docker Compose') {
            steps {
                script {
                    echo 'Deploying with Docker Compose...'
                    withEnv(["MYSQL_PASSWORD=${MYSQL_PASSWORD}", "MYSQL_DATABASE=${MYSQL_DATABASE}", "SPRING_PROFILES_ACTIVE=prod"]) {
                        sh './docker-compose pull'
                        sh './docker-compose up -d'
                    }   
                    sh 'docker logout'
                    echo 'Deploy Success!'
                }
            }
        }
    }

    post {
        success {
            echo 'All Completed Successfully!'
        }
    }
}
